<div class="microblog">
  <div class="body-content">
    <h2>Microblog</h2>
    <p>Short updates and development notes from the trenches.</p>
    
    <!-- New Post Form -->
    <div class="microblog-form-container">
      <form id="microblog-form" class="microblog-form">
        <div class="form-group">
          <input 
            type="text" 
            id="subject" 
            placeholder="Subject (optional)" 
            maxlength="100"
            class="form-input"
          >
        </div>
        <div class="form-group">
          <textarea 
            id="content" 
            placeholder="What's happening?" 
            maxlength="5000"
            rows="4"
            class="form-textarea"
            required
          ></textarea>
          <div class="char-count">
            <span id="char-counter">0</span>/5000
          </div>
        </div>
        <div class="form-group">
          <button type="submit" class="form-button" id="submit-btn">
            Post Update
          </button>
        </div>
      </form>
    </div>

    <!-- Posts Container -->
    <div id="microblog-posts" class="microblog-posts">
      <div class="loading">Loading posts...</div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('microblog-form');
  const subjectInput = document.getElementById('subject');
  const contentTextarea = document.getElementById('content');
  const charCounter = document.getElementById('char-counter');
  const submitBtn = document.getElementById('submit-btn');
  const postsContainer = document.getElementById('microblog-posts');

  // Character counter
  contentTextarea.addEventListener('input', function() {
    const length = this.value.length;
    charCounter.textContent = length;
    
    if (length > 4500) {
      charCounter.style.color = '#ff6b6b';
    } else {
      charCounter.style.color = '#666';
    }
  });

  // Load existing posts
  async function loadPosts() {
    try {
      const response = await fetch('/api/microblog');
      if (!response.ok) throw new Error('Failed to load posts');
      
      const posts = await response.json();
      displayPosts(posts);
    } catch (error) {
      console.error('Error loading posts:', error);
      postsContainer.innerHTML = '<div class="error">Failed to load posts.</div>';
    }
  }

  // Display posts
  function displayPosts(posts) {
    if (posts.length === 0) {
      postsContainer.innerHTML = '<div class="no-posts">No posts yet. Be the first to share an update!</div>';
      return;
    }

    const postsHtml = posts.map(post => `
      <div class="microblog-post">
        <div class="post-header">
          ${post.subject ? `<div class="post-subject">${escapeHtml(post.subject)}</div>` : ''}
          <div class="post-date">${post.date}</div>
        </div>
        <div class="post-content">${escapeHtml(post.content)}</div>
      </div>
    `).join('');

    postsContainer.innerHTML = postsHtml;
  }

  // Escape HTML to prevent XSS
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;")
      .replace(/\n/g, '<br>');
  }

  // Handle form submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const subject = subjectInput.value.trim();
    const content = contentTextarea.value.trim();
    
    if (!content) {
      alert('Please enter some content for your post.');
      return;
    }

    // Disable form while submitting
    submitBtn.disabled = true;
    submitBtn.textContent = 'Posting...';

    try {
      const response = await fetch('/api/microblog', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ subject, content })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to post update');
      }

      const result = await response.json();
      
      // Clear form
      subjectInput.value = '';
      contentTextarea.value = '';
      charCounter.textContent = '0';
      
      // Reload posts to show the new one
      await loadPosts();
      
      // Show success message briefly
      submitBtn.textContent = 'Posted!';
      setTimeout(() => {
        submitBtn.textContent = 'Post Update';
      }, 2000);

    } catch (error) {
      console.error('Error posting update:', error);
      alert('Failed to post update: ' + error.message);
    } finally {
      submitBtn.disabled = false;
      if (submitBtn.textContent === 'Posting...') {
        submitBtn.textContent = 'Post Update';
      }
    }
  });

  // Load posts on page load
  loadPosts();
});
</script>